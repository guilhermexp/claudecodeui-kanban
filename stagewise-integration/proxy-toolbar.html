<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stagewise Toolbar with Proxy</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      height: 100vh;
      overflow: hidden;
    }
    
    #app-frame {
      width: 100%;
      height: 100vh;
      border: none;
    }
    
    /* Stagewise Toolbar */
    #stagewise-toolbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      transition: all 0.3s ease;
    }
    
    #stagewise-toolbar.dark {
      background: rgba(30, 30, 30, 0.95);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .toolbar-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .toolbar-button:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .toolbar-button.active {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }
    
    .toolbar-button.select-mode {
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
    }
    
    .toolbar-button.chat {
      background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
    }
    
    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 8px;
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 12px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .toolbar-button:hover .tooltip {
      opacity: 1;
    }
    
    /* Chat Panel */
    #chat-panel {
      position: fixed;
      right: 20px;
      bottom: 80px;
      width: 350px;
      height: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      display: none;
      flex-direction: column;
      z-index: 10001;
    }
    
    #chat-panel.active {
      display: flex;
    }
    
    .chat-header {
      padding: 16px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-title {
      font-weight: 600;
      color: #2d3748;
    }
    
    .chat-close {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #f7fafc;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }
    
    .message {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 8px;
      max-width: 80%;
    }
    
    .message.user {
      background: #667eea;
      color: white;
      margin-left: auto;
    }
    
    .message.assistant {
      background: #f7fafc;
      color: #2d3748;
    }
    
    .selected-element-info {
      background: #edf2f7;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 12px;
    }
    
    .chat-input-container {
      padding: 16px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 8px;
    }
    
    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .chat-send {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    
    /* Selection Indicator */
    #selection-indicator {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      display: none;
      z-index: 10002;
      animation: slideDown 0.3s ease;
    }
    
    #selection-indicator.active {
      display: block;
    }
    
    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <!-- User app iframe -->
  <iframe id="app-frame" src="http://localhost:5173"></iframe>
  
  <!-- Selection mode indicator -->
  <div id="selection-indicator">
    ðŸŽ¯ Selection mode active - Click any element
  </div>
  
  <!-- Stagewise Toolbar -->
  <div id="stagewise-toolbar">
    <button class="toolbar-button select-mode" id="select-btn">
      ðŸŽ¯
      <span class="tooltip">Select Element</span>
    </button>
    <button class="toolbar-button chat" id="chat-btn">
      ðŸ’¬
      <span class="tooltip">AI Chat</span>
    </button>
    <button class="toolbar-button" id="refresh-btn">
      ðŸ”„
      <span class="tooltip">Refresh</span>
    </button>
  </div>
  
  <!-- Chat Panel -->
  <div id="chat-panel">
    <div class="chat-header">
      <div class="chat-title">Stagewise AI Assistant</div>
      <button class="chat-close" id="close-chat">âœ•</button>
    </div>
    <div class="chat-messages" id="messages"></div>
    <div class="chat-input-container">
      <input type="text" class="chat-input" id="chat-input" placeholder="Ask about the selected element...">
      <button class="chat-send" id="send-btn">Send</button>
    </div>
  </div>
  
  <script>
    const iframe = document.getElementById('app-frame');
    const selectBtn = document.getElementById('select-btn');
    const chatBtn = document.getElementById('chat-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const chatPanel = document.getElementById('chat-panel');
    const closeChat = document.getElementById('close-chat');
    const messages = document.getElementById('messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const selectionIndicator = document.getElementById('selection-indicator');
    
    let isSelectionMode = false;
    let selectedElement = null;
    let ws = null;
    
    // Initialize WebSocket connection to adapter
    function initWebSocket() {
      ws = new WebSocket('ws://localhost:3456/ws');
      
      ws.onopen = () => {
        console.log('Connected to Stagewise adapter');
      };
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'response') {
          addMessage(data.content, 'assistant');
        }
      };
      
      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
      
      ws.onclose = () => {
        console.log('WebSocket connection closed');
        // Reconnect after 2 seconds
        setTimeout(initWebSocket, 2000);
      };
    }
    
    // Toggle selection mode
    function toggleSelectionMode() {
      isSelectionMode = !isSelectionMode;
      selectBtn.classList.toggle('active');
      selectionIndicator.classList.toggle('active');
      
      // Send message to iframe
      iframe.contentWindow.postMessage({
        type: isSelectionMode ? 'enableSelection' : 'disableSelection'
      }, '*');
    }
    
    // Handle element selection
    function handleElementSelection(elementInfo) {
      selectedElement = elementInfo;
      
      // Show in chat
      const info = document.createElement('div');
      info.className = 'selected-element-info';
      info.innerHTML = `
        <strong>Selected Element:</strong><br>
        Tag: ${elementInfo.tag}<br>
        Selector: ${elementInfo.selector}<br>
        ${elementInfo.text ? `Text: ${elementInfo.text.substring(0, 50)}...` : ''}
      `;
      messages.appendChild(info);
      messages.scrollTop = messages.scrollHeight;
      
      // Auto-open chat
      if (!chatPanel.classList.contains('active')) {
        chatPanel.classList.add('active');
      }
      
      // Turn off selection mode
      toggleSelectionMode();
    }
    
    // Add message to chat
    function addMessage(text, sender) {
      const message = document.createElement('div');
      message.className = `message ${sender}`;
      message.textContent = text;
      messages.appendChild(message);
      messages.scrollTop = messages.scrollHeight;
    }
    
    // Send message
    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      
      addMessage(text, 'user');
      
      // Include element context if available
      const context = selectedElement ? 
        `Context: User selected a ${selectedElement.tag} element with selector "${selectedElement.selector}". ` : '';
      
      // Send to adapter
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'user_message',
          content: [{
            type: 'text',
            text: context + text
          }]
        }));
      }
      
      chatInput.value = '';
    }
    
    // Event listeners
    selectBtn.addEventListener('click', toggleSelectionMode);
    
    chatBtn.addEventListener('click', () => {
      chatPanel.classList.toggle('active');
    });
    
    closeChat.addEventListener('click', () => {
      chatPanel.classList.remove('active');
    });
    
    refreshBtn.addEventListener('click', () => {
      iframe.src = iframe.src;
    });
    
    sendBtn.addEventListener('click', sendMessage);
    
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    // Listen for messages from iframe
    window.addEventListener('message', (event) => {
      if (event.data.type === 'elementSelected') {
        handleElementSelection(event.data.element);
      } else if (event.data.type === 'selectionScriptReady') {
        console.log('Selection script loaded in iframe');
      }
    });
    
    // Initialize WebSocket
    initWebSocket();
    
    // Handle iframe navigation
    iframe.addEventListener('load', () => {
      console.log('Iframe loaded:', iframe.contentWindow.location.href);
      // Reset selection mode if it was active
      if (isSelectionMode) {
        setTimeout(() => {
          iframe.contentWindow.postMessage({ type: 'enableSelection' }, '*');
        }, 100);
      }
    });
  </script>
</body>
</html>